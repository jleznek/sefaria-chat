<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' https://cdn.jsdelivr.net;
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                   font-src https://fonts.gstatic.com;
                   connect-src https://mcp.sefaria.org https://developers.sefaria.org https://generativelanguage.googleapis.com;
                   frame-src https: http:;">
    <title>Sefaria Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Frank+Ruhl+Libre:wght@400;500;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Setup overlay (shown when no API key is set) -->
    <div id="setup-overlay" class="hidden">
        <div class="setup-card">
            <div class="setup-logo">
                <svg width="56" height="56" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="8" width="10" height="48" rx="5" fill="#8B6914" stroke="#5C4410" stroke-width="1.5"/>
                    <rect x="50" y="8" width="10" height="48" rx="5" fill="#8B6914" stroke="#5C4410" stroke-width="1.5"/>
                    <rect x="6" y="5" width="6" height="4" rx="2" fill="#A67C1A"/>
                    <rect x="6" y="55" width="6" height="4" rx="2" fill="#A67C1A"/>
                    <rect x="52" y="5" width="6" height="4" rx="2" fill="#A67C1A"/>
                    <rect x="52" y="55" width="6" height="4" rx="2" fill="#A67C1A"/>
                    <rect x="14" y="12" width="36" height="40" rx="2" fill="#F5F0E0" stroke="#C4B07A" stroke-width="0.75"/>
                    <line x1="18" y1="20" x2="46" y2="20" stroke="#B8A67A" stroke-width="1" stroke-linecap="round"/>
                    <line x1="18" y1="26" x2="46" y2="26" stroke="#B8A67A" stroke-width="1" stroke-linecap="round"/>
                    <line x1="18" y1="32" x2="46" y2="32" stroke="#B8A67A" stroke-width="1" stroke-linecap="round"/>
                    <line x1="18" y1="38" x2="46" y2="38" stroke="#B8A67A" stroke-width="1" stroke-linecap="round"/>
                    <line x1="18" y1="44" x2="38" y2="44" stroke="#B8A67A" stroke-width="1" stroke-linecap="round"/>
                </svg>
            </div>
            <h1>Sefaria Chat</h1>
            <p>Explore Jewish texts from the Sefaria digital library, powered by AI.</p>
            <p class="setup-subtitle">Choose your AI provider and enter your API key.</p>
            <div class="setup-provider-row">
                <select id="setup-provider" class="provider-select">
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="setup-input-group">
                <input type="password" id="setup-api-key" placeholder="AIza..." autocomplete="off">
                <button id="setup-save-btn">Get Started</button>
            </div>
            <p class="setup-hint">Your key is stored locally and never shared. Get a key from <a id="setup-key-link" href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>.</p>
            <p class="setup-disclaimer">This app is not developed by or affiliated with <a href="https://www.sefaria.org" target="_blank">Sefaria.org</a>. It uses Sefaria's publicly available <a href="https://developers.sefaria.org/docs/the-sefaria-mcp" target="_blank">MCP servers</a>.<br>&copy; 2026 Jason Leznek</p>
        </div>
    </div><!-- end setup-overlay -->

    <!-- Wrapper for side-by-side layout -->
    <div id="split-container">
    <!-- Main app -->
    <div id="app">
        <!-- Header -->
        <header id="header">
            <div class="header-left">
                <button id="history-btn" class="icon-btn" title="Chat history">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <span class="logo">
                    <svg width="24" height="24" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="8" width="10" height="48" rx="5" fill="#ccb479" stroke="#A67C1A" stroke-width="1.5"/>
                        <rect x="50" y="8" width="10" height="48" rx="5" fill="#ccb479" stroke="#A67C1A" stroke-width="1.5"/>
                        <rect x="6" y="5" width="6" height="4" rx="2" fill="#e0cc8a"/>
                        <rect x="6" y="55" width="6" height="4" rx="2" fill="#e0cc8a"/>
                        <rect x="52" y="5" width="6" height="4" rx="2" fill="#e0cc8a"/>
                        <rect x="52" y="55" width="6" height="4" rx="2" fill="#e0cc8a"/>
                        <rect x="14" y="12" width="36" height="40" rx="2" fill="#F5F0E0" stroke="#C4B07A" stroke-width="0.75"/>
                        <line x1="18" y1="20" x2="46" y2="20" stroke="#d4c494" stroke-width="1"/>
                        <line x1="18" y1="26" x2="46" y2="26" stroke="#d4c494" stroke-width="1"/>
                        <line x1="18" y1="32" x2="46" y2="32" stroke="#d4c494" stroke-width="1"/>
                        <line x1="18" y1="38" x2="46" y2="38" stroke="#d4c494" stroke-width="1"/>
                        <line x1="18" y1="44" x2="38" y2="44" stroke="#d4c494" stroke-width="1"/>
                    </svg>
                </span>
                <h1>Sefaria Chat</h1>
                <span id="mcp-badge" class="badge badge-connecting" title="MCP connection status">Connecting‚Ä¶</span>
            </div>
            <div class="header-right">
                <button id="new-chat-btn" class="icon-btn" title="New chat">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                </button>
                <button id="clear-btn" class="icon-btn" title="Clear conversation">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                </button>
                <button id="print-btn" class="icon-btn" title="Print conversation">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
                    </svg>
                </button>
                <button id="settings-btn" class="icon-btn" title="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- History sidebar -->
        <div id="history-sidebar" class="hidden">
            <div class="sidebar-header">
                <h2>Chat History</h2>
                <button id="close-sidebar-btn" class="icon-btn sidebar-close" title="Close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="history-list" class="history-list"></div>
        </div>

        <!-- Settings page (hidden by default, replaces chat content) -->
        <div id="settings-panel" class="hidden">
            <div class="settings-page">
                <div class="settings-page-header">
                    <h2>Settings</h2>
                    <button id="settings-close-btn" class="settings-back-btn" title="Back to chat">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="settings-content">
                    <div class="settings-section">
                        <h3>Active Providers</h3>
                        <p class="settings-section-hint">Click a configured provider to make it the default.</p>
                        <div id="activated-providers" class="activated-providers"></div>
                    </div>
                    <div class="settings-section">
                        <h3>Add a Provider</h3>
                        <div class="settings-provider-row">
                            <select id="settings-provider" class="provider-select"></select>
                            <select id="settings-model" class="provider-select model-select"></select>
                        </div>
                        <div class="setup-input-group" style="margin-top: 12px;">
                            <input type="password" id="settings-api-key" placeholder="Enter new key..." autocomplete="off">
                            <button id="settings-save-btn">Save</button>
                        </div>
                        <p id="settings-key-hint" class="settings-key-hint"></p>
                    </div>
                    <div class="settings-section">
                        <h3>Connection</h3>
                        <button id="reconnect-btn" class="secondary-btn">Reconnect MCP Servers</button>
                    </div>
                    <div class="settings-section">
                        <h3>Preferences</h3>
                        <label class="settings-toggle-row">
                            <span>Auto-scroll during responses</span>
                            <input type="checkbox" id="auto-scroll-toggle" checked>
                            <span class="toggle-switch"></span>
                        </label>
                    </div>
                    <div class="settings-section">
                        <h3>Updates</h3>
                        <div class="settings-update-row">
                            <button id="check-updates-btn" class="secondary-btn">Check for Updates</button>
                            <span id="update-check-status" class="update-check-status"></span>
                        </div>
                        <div id="settings-update-progress" class="settings-update-row hidden">
                            <div class="update-progress-bar"><div id="update-progress-fill" class="update-progress-fill"></div></div>
                            <span id="update-progress-pct" class="update-check-status"></span>
                        </div>
                        <div id="settings-update-install" class="settings-update-row hidden">
                            <button id="settings-install-btn" class="secondary-btn update-install-btn">Restart &amp; Install</button>
                            <span id="settings-update-version" class="update-check-status"></span>
                        </div>
                        <p class="settings-version">Version <span id="app-version"></span></p>
                    </div>
                    <div class="settings-section about-section">
                        <h3>About</h3>
                        <p class="about-description">Sefaria Chat is an independent desktop app for exploring the <a href="https://www.sefaria.org" target="_blank">Sefaria</a> library of Jewish texts, powered by AI.</p>
                        <div class="about-links">
                            <a href="https://github.com/jleznek/sefaria-chat" target="_blank" class="about-link">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
                                GitHub
                            </a>
                            <a href="https://www.sefaria.org/donate" target="_blank" class="about-link donate-link">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                Donate to Sefaria
                            </a>
                        </div>
                        <details class="changelog-details">
                            <summary>Change Log</summary>
                            <div id="changelog-content" class="changelog-content"></div>
                        </details>
                        <p class="about-disclaimer">This app is not developed by or affiliated with <a href="https://www.sefaria.org" target="_blank">Sefaria.org</a>.<br>It uses Sefaria's publicly available MCP servers.</p>
                        <p class="about-copyright">&copy; 2026 Jason Leznek &middot; <a href="https://github.com/jleznek/sefaria-chat/blob/main/LICENSE" target="_blank">MIT License</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat messages -->
        <main id="chat-container">
            <div id="messages">
                <div class="welcome-message">
                    <h2>Welcome to Sefaria Chat</h2>
                    <p>Ask about Jewish texts, explore the library, or dive into Torah topics.</p>
                    <div class="suggested-prompts">
                        <button class="prompt-card" data-prompt="What is today's Torah portion and Daf Yomi?">üìÖ What is today's Torah portion and Daf Yomi?</button>
                        <button class="prompt-card" data-prompt="What does Judaism teach about forgiveness and repentance?">üîç What does Judaism teach about forgiveness and repentance?</button>
                        <button class="prompt-card" data-prompt="Show me an ancient manuscript of Genesis 1:1">üìú Show me an ancient manuscript of Genesis 1:1</button>
                        <button class="prompt-card" data-prompt="What does the Hebrew word 'chesed' mean? Look it up in the dictionaries.">üìñ What does the Hebrew word "chesed" mean?</button>
                        <button class="prompt-card" data-prompt="Tell me about the topic of Shabbat ‚Äî its sources, themes, and subtopics">‚ú°Ô∏è Tell me about the topic of Shabbat</button>
                        <button class="prompt-card" data-prompt="Compare the English translations of Psalm 23">üåê Compare translations of Psalm 23</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Input area -->
        <footer id="input-area">
            <div class="input-options-bar">
                <div class="response-length-bar">
                    <span class="response-length-label">Response:</span>
                    <button class="length-option active" data-length="concise">Concise</button>
                    <button class="length-option" data-length="balanced">Balanced</button>
                    <button class="length-option" data-length="detailed">Detailed</button>
                </div>
                <div class="model-picker">
                    <select id="model-picker-select" title="Switch AI model">
                        <!-- populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="input-row">
                <textarea id="message-input" placeholder="Ask about the Torah‚Ä¶" rows="1"></textarea>
                <button id="send-btn" title="Send" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </footer>
        <div id="rate-limit-bar">
            <div class="rate-limit-inner">
                <span id="rate-limit-text">API: 0 / 20 requests used</span>
                <div class="rate-limit-meter">
                    <div id="rate-limit-fill" class="rate-limit-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div id="disclaimer-bar">Not developed by or affiliated with <a href="https://www.sefaria.org" target="_blank">Sefaria.org</a> &bull; Uses Sefaria's <a href="https://developers.sefaria.org/docs/the-sefaria-mcp" target="_blank">MCP</a> &bull; &copy; 2026 Jason Leznek</div>
        <div id="donate-bar"><a href="https://www.sefaria.org/ways-to-give" target="_blank">Support Sefaria &mdash; Donate</a></div>
        <div id="update-bar" class="hidden">
            <span id="update-text">An update is available</span>
            <button id="update-action" class="update-btn">Restart to update</button>
            <button id="update-dismiss" class="update-dismiss">&times;</button>
        </div>
    </div><!-- end #app -->

    <!-- Draggable splitter -->
    <div id="split-handle" class="hidden"></div>

    <!-- Embedded browser pane for links -->
    <div id="webview-panel" class="hidden">
        <div class="webview-toolbar">
            <button id="webview-back" title="Back">&#8592;</button>
            <button id="webview-forward" title="Forward">&#8594;</button>
            <span id="webview-title" class="webview-url">Loading‚Ä¶</span>
            <button id="webview-external" title="Open in browser">&#8599;</button>
            <button id="webview-print" title="Print page">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
                </svg>
            </button>
            <button id="webview-close" title="Close">&times;</button>
        </div>
        <webview id="webview-content" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></webview>
    </div>
    </div><!-- end #split-container -->

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script src="renderer.js"></script>
</body>
</html>
